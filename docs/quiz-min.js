var keyboard,notation,quiz;function parseQueryString(query){var vars=query.split("&");var obj={}
for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");obj[pair[0]]=pair[1];}
return obj;}
function showKeyboard(options){var options=parseQueryString(options);keyboard=new Keyboard($.extend({el:$("#keyboard"),onClick:noteClick},options));}
function noteClick(clickedButton){var $btn=$(clickedButton);var note=new Note($btn.data("note"));if(quiz.started){if(note.numericValue===quiz.lastQuestion.numericValue){quiz.right($btn);}else{quiz.wrong($btn);}}else{notation.draw(note);$("#keyboard .button").removeClass("selected");$("#keyboard .button[data-note='"+note.numericValue+"']").addClass("selected");}}
$(document).ready(function(){showKeyboard($("select option:first").val());notation=new Notation({el:$("#notation")});quiz=new Quiz();});function Quiz(){this.totalQuestions=5;this.started=false;this.lastQuestion=null;this.lastQuestionTime=null;this.answerTime=null;this.questionsAsked=0;this.averageResponseTime=0;this.bestTime=null;this.quizBtn=$("#quizBtn");this.lastScoreDisplay=$("#lastScore");this.bestScoreDisplay=$("#bestScore");this.keyboardSelector=$("#keyboardSelector");}
Quiz.prototype={average:function(currentAverage,newValue){return((currentAverage*(this.questionsAsked-1))+newValue)/this.questionsAsked;},buttonClick:function(){if(this.started){this.end();this.quizBtn.text("Start Quiz")}else{this.start();this.quizBtn.text("End Quiz");}},start:function(){keyboard.hideText();this.keyboardSelector.prop("disabled","disabled");this.started=true;this.askQuestion();},end:function(){this.quizBtn.text("Start Quiz");this.keyboardSelector.prop("disabled",false);keyboard.showText();keyboard.deselect();notation.reset();this.started=false;this.handleScores();this.questionsAsked=0;},handleScores:function(){if(this.bestTime==null||this.averageResponseTime<this.bestTime){this.bestTime=this.averageResponseTime;}
this.lastScoreDisplay.text((this.averageResponseTime/1000).toFixed(2));this.bestScoreDisplay.text((this.bestTime/1000).toFixed(2));this.averageResponseTime=0;},right:function($el){var answerTime=Date.now();var responseTime=answerTime-this.lastQuestionTime;this.averageResponseTime=this.average(this.averageResponseTime,responseTime);this.addMarker($el,"right");this.hideMarker($el);if(this.questionsAsked>=this.totalQuestions){this.end();}else{this.askQuestion();}},wrong:function($el){this.addMarker($el,"wrong");this.hideMarker($el);},addMarker:function($el,type){$el.append("<div class='marker "+type+"'></div>");},hideMarker:function($el){var marker=$el.find(".marker");marker.fadeOut(900,function(){marker.remove();});},askQuestion:function(){keyboard.deselect();var high=keyboard.highestNote;var low=keyboard.lowestNote;var r=low+Math.floor((Math.random()*(high-low)));if((this.lastQuestion&&r==this.lastQuestion.numericValue)){this.askQuestion();}else{this.lastQuestion=new Note(r,(Math.round(Math.random())==1));notation.draw(this.lastQuestion);this.lastQuestionTime=Date.now();this.questionsAsked++;}}}
function Notation(options){this.el=options.el;this.svgns="http://www.w3.org/2000/svg";this.positions={"c":0,"d":-10,"e":-20,"f":-30,"g":-40,"a":-50,"b":-60};this.octaveOffsets={3:70,4:0,5:-70,6:-140};this.addSvgObj();}
Notation.prototype={addSvgObj:function(){var self=this;var svgObj=document.createElement("object");svgObj.data="note_on_staff.svg";svgObj.type="image/svg+xml";svgObj.onload=function(){self.render()};this.el.append(svgObj);},render:function(){this.svg=this.el.find("object")[0].contentDocument;this.noteHead=this.svg.getElementById("note");this.sharp=this.svg.getElementById("sharp");this.flat=this.svg.getElementById("flat");this.staff=this.svg.getElementById("staff");this.staffBBox=this.staff.getBBox();this.reset();if(this.pendingNote){this.draw(this.pendingNote);}},draw:function(note){if(!this.svg){this.pendingNote=note;return;}
this.reset();this.show(this.noteHead);var notePosition=this.computePosition(note);if(note.text.charAt(1)=="b"){this.show(this.flat,notePosition);}else if(note.text.charAt(1)=="#"){this.show(this.sharp,notePosition);}
this.showHelperLines(notePosition);this.noteHead.setAttribute("transform","translate(0,"+notePosition+")");},computePosition:function(note){var start=this.octaveOffsets[note.octave];return start+this.positions[note.text.charAt(0)];},show:function(el,position){el.setAttribute('visibility','visible');if(position){el.setAttribute("transform","translate(0,"+position+")");}},hide:function(el){el.setAttribute('visibility','hidden');},reset:function(){this.hide(this.flat);this.hide(this.sharp);this.hide(this.noteHead);this.removeAllHelperLines();},removeAllHelperLines:function(){while(this.staff.getElementsByClassName("helper").length>0){this.staff.removeChild(this.staff.getElementsByClassName("helper")[0])}},addHelperLinesBelow:function(p){var lines=Math.floor(p/20)+1;for(var i=0;i<lines;i++){this.addHelperLine(this.staffBBox.height+this.staffBBox.y+(i*20)+18);}},addHelperLinesAbove:function(p){var pMod=p*(-1)-120;var lines=Math.floor(pMod/20)+1;for(var i=0;i<lines;i++){this.addHelperLine(this.staffBBox.y-((i+1)*20));}},showHelperLines:function(p){if(p>=0){this.addHelperLinesBelow(p);}else if(p<=-120){this.addHelperLinesAbove(p);}},addHelperLine:function(y){var r=this.svg.createElementNS(this.svgns,"rect");r.setAttributeNS(null,"height",2);r.setAttributeNS(null,"width",45);r.setAttributeNS(null,"class","helper");r.setAttributeNS(null,"x",85);r.setAttributeNS(null,"y",y);this.staff.appendChild(r);}}
NOTES=['c','c#','db','d','d#','eb','e','f','f#','gb','g','g#','ab','a','a#','bb','b'];VALUES=[0,1,1,2,3,3,4,5,6,6,7,8,8,9,10,10,11];function Note(info,preferFlatName){this.preferFlatName=preferFlatName||false;this.parseInfo(info);}
Note.prototype={parseInfo:function(info){if(typeof(info)=="string"){this.text=info;this.setNameAndOctave(info.split(""));this.setNumericValue();}else if(typeof(info)=="number"){this.numericValue=info;this.name=this.getName();this.text=this.getText();this.octave=this.getOctave();}},setNameAndOctave:function(parts){if(parts.length==3&&!isNaN(parts[2])){this.name=parts[0]+""+parts[1];this.octave=parseInt(parts[2]);}else if(parts.length==2&&!isNaN(parts[1])){this.name=parts[0];this.octave=parseInt(parts[1]);}else if(parts.length==1){this.name=parts[0];this.octave=4;}},setNumericValue:function(){this.numericValue=VALUES[NOTES.indexOf(this.name)]+(this.octave*12);},getOctave:function(){return Math.floor(this.numericValue/12);},getName:function(){while(this.numericValue<0){this.numericValue+=12;}
var name;if(this.preferFlatName){name=NOTES[VALUES.lastIndexOf(this.numericValue%12)];}else{name=NOTES[VALUES.indexOf(this.numericValue%12)];}
return name;},getText:function(){return this.name+""+this.getOctave();}}
function Keyboard(options){this.el=options.el;this.displayRows=options.displayRows?parseInt(options.displayRows):5;this.startNote=new Note(options.startNote);this.startNoteNumericValue=this.startNote.numericValue;this.lowestNote=null;this.highestNote=null;this.buttonsPerRow=options.buttonsPerRow?parseInt(options.buttonsPerRow):14;this.clickCallback=options.onClick;this.systemRows=parseInt(options.systemRows);this.stepSize=parseInt(options.stepSize);this.render();this.attachEvents();}
Keyboard.prototype={attachEvents:function(){var self=this;if(this.clickCallback){this.el.on("click",".button",function(evt){self.clickCallback(evt.target);})}},render:function(){this.el.unbind();this.el.empty();for(var i=this.displayRows-1;i>-1;i--){var extraClass=(i%2==0)?"even":""
this.el.append("<div class='row "+extraClass+" row_"+i+"'></div>");this.addButtonsToRow(i);}},toggleNoteNames:function(){this.el.find(".button").toggleClass("note-name text-off-screen");},hideText:function(){this.el.find(".button").addClass("text-off-screen");},showText:function(){this.el.find(".button").removeClass("text-off-screen");},deselect:function(){this.el.find(".button").removeClass("selected");},compareToHighestAndLowestNote:function(noteValue){if(this.highestNote==null||noteValue>this.highestNote){this.highestNote=noteValue;}
if(this.lowestNote==null||noteValue<this.lowestNote){this.lowestNote=noteValue;}},getNoteAt:function(x,y){x-=Math.ceil(y/2);var newNoteValue=(this.startNoteNumericValue+(y*this.stepSize)+(this.systemRows*x));this.compareToHighestAndLowestNote(newNoteValue);return new Note(newNoteValue);},addButtonsToRow:function(row){var buttonsPerRowAdjusted=this.buttonsPerRow+(row%2);for(var i=0;i<buttonsPerRowAdjusted;i++){var note=this.getNoteAt(i,row);var color=(note.text.length==3)?"black":"white";$('<div/>',{"class":'note-name non-selectable button '+color,"data-note":note.numericValue,"text":note.text}).appendTo(this.el.find(".row_"+row));}}}